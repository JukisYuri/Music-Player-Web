{% extends "unfold/layouts/base.html" %}
{% load i18n %}

{% block content %}
  {# --- KPI CARDS --- #}
  {% if kpi %}
  <div class="grid grid-cols-1 gap-4 mb-8 md:grid-cols-2 lg:grid-cols-4">
      {% for item in kpi %}
      <div class="flex flex-col p-6 bg-white border rounded-lg shadow-sm dark:bg-gray-800 dark:border-gray-700">
          <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">{{ item.title }}</h3>
          <span class="mt-2 text-3xl font-bold text-gray-900 dark:text-gray-100">{{ item.metric }}</span>
          {% if item.footer %}
          <span class="mt-2 text-sm text-{{ item.color|default:'gray' }}-600 dark:text-{{ item.color|default:'gray' }}-400">
              {{ item.footer }}
          </span>
          {% endif %}
      </div>
      {% endfor %}
  </div>
  {% endif %}

  {# --- CHARTS SECTION --- #}
 <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">

      <div class="p-6 bg-white border rounded-lg shadow-sm dark:bg-gray-800 dark:border-gray-700">
          <h2 class="mb-4 text-lg font-semibold text-gray-900 dark:text-gray-100">
              Top 15 Bài hát nghe nhiều nhất
          </h2>
          <div class="relative h-[400px]">
              <canvas id="viewsChart"></canvas>
          </div>
      </div>

      <div class="p-6 bg-white border rounded-lg shadow-sm dark:bg-gray-800 dark:border-gray-700 " >
          <h2 class="mb-4 text-lg font-semibold text-gray-900 dark:text-gray-100">
              Phân tích cảm xúc bình luận (Top 15)
          </h2>
          <div class="relative h-[400px]">
              <canvas id="sentimentChart"></canvas>
          </div>
      </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
      document.addEventListener('DOMContentLoaded', function() {

          // Lấy dữ liệu
          const viewsData = JSON.parse('{{ chart_views_data|safe }}');
          const sentimentData = JSON.parse('{{ chart_sentiment_data|safe }}');

          const commonOptions = {
              responsive: true,
              maintainAspectRatio: false,
          };

          // 1. Chart Views (Cột đơn)
          new Chart(document.getElementById('viewsChart'), {
              type: 'bar',
              data: {
                  labels: viewsData.labels,
                  datasets: [{
                      label: 'Lượt nghe',
                      data: viewsData.data,
                      backgroundColor: 'rgba(59, 130, 246, 0.6)', // Blue
                      borderColor: 'rgb(59, 130, 246)',
                      borderWidth: 1
                  }]
              },
              options: commonOptions
          });

          // 2. Chart Sentiment (Cột chồng - Stacked Bar)
          new Chart(document.getElementById('sentimentChart'), {
              type: 'bar',
              data: {
                  labels: sentimentData.labels,
                  datasets: [
                      {
                          label: 'Tích cực',
                          data: sentimentData.pos,
                          backgroundColor: 'rgba(34, 197, 94, 0.7)', // Green
                          stack: 'Stack 0',
                      },
                      {
                          label: 'Trung tính',
                          data: sentimentData.neu,
                          backgroundColor: 'rgba(156, 163, 175, 0.7)', // Gray
                          stack: 'Stack 0',
                      },
                      {
                          label: 'Tiêu cực',
                          data: sentimentData.neg,
                          backgroundColor: 'rgba(239, 68, 68, 0.7)', // Red
                          stack: 'Stack 0',
                      }
                  ]
              },
              options: {
                  ...commonOptions,
                  scales: {
                      x: {
                          stacked: true, // Quan trọng: Để các cột chồng lên nhau
                          ticks: { autoSkip: false, maxRotation: 90, minRotation: 45 }
                      },
                      y: {
                          stacked: true,
                          beginAtZero: true
                      }
                  },
                  interaction: {
                      mode: 'index',
                      intersect: false,
                  },
              }
          });
      });
  </script>
{% endblock %}